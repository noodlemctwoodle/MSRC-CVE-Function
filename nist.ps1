$apiKey = "1111-11111-11111-11111-1111"
$name = "CVE-2021-44228"
$nist = (Invoke-WebRequest -Uri "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=$name" -Headers @{Accept = "application/json"; Key=$apiKey}).Content | ConvertFrom-Json -Depth 99

function ConvertPropertiesToIndividualKeys($metrics) {
    $result = @{}
    $metrics.PSObject.Properties | ForEach-Object {
        $result[$_.Name] = $_.Value
    }
    return $result
}

# Assuming $nist.vulnerabilities is an array and we are using the first element in this example
$vulnerability = $nist.vulnerabilities[0]

$metricsV2Properties = ConvertPropertiesToIndividualKeys $vulnerability.cve.metrics.cvssMetricV2[0].cvssData
$metricsV31Properties = ConvertPropertiesToIndividualKeys $vulnerability.cve.metrics.cvssMetricV31[0].cvssData

# Prepare arrays for URLs and Tags
$urls = @()
$tags = @()

# Iterate over references to extract URLs and Tags
foreach ($reference in $vulnerability.cve.references) {
    $urls += $reference.url
    $tags += $reference.tags
}

# Remove duplicates from URLs and Tags arrays
$urls = $urls | Sort-Object | Get-Unique
$tags = $tags | Sort-Object | Get-Unique

# Create a custom object
# Create a custom object with ordered properties
$cveObject = New-Object PSObject -Property ([ordered]@{
    id                      = $vulnerability.cve.id
    sourceIdentifier        = $vulnerability.cve.sourceIdentifier
    published               = $vulnerability.cve.published
    lastModified            = $vulnerability.cve.lastModified
    vulnStatus              = $vulnerability.cve.vulnStatus
    descriptions            = ($vulnerability.cve.descriptions | Where-Object { $_.lang -eq 'en' })[0].value
    references              = $vulnerability.cve.references[0].url
    configurations          = $vulnerability.cve.configurations[0].nodes -join ", "
    weaknesses              = ($vulnerability.cve.weaknesses | ForEach-Object { $_.description | Where-Object { $_.lang -eq 'en' } | ForEach-Object { $_.value } }) -join ", "
    accessVector            = $metricsV2Properties.accessVector
    accessComplexity        = $metricsV2Properties.accessComplexity
    authentication          = $metricsV2Properties.authentication
    integrityImpact         = $metricsV31Properties.integrityImpact
    availabilityImpact      = $metricsV31Properties.availabilityImpact
    attackVector            = $metricsV31Properties.attackVector
    baseScore               = $metricsV31Properties.baseScore
    confidentialityImpact   = $metricsV31Properties.confidentialityImpact
    userInteraction         = $metricsV31Properties.userInteraction
    version                 = $metricsV31Properties.version
    scope                   = $metricsV31Properties.scope
    privilegesRequired      = $metricsV31Properties.privilegesRequired
    attackComplexity        = $metricsV31Properties.attackComplexity
    vectorString            = $metricsV31Properties.vectorString
    baseSeverity            = $metricsV31Properties.baseSeverity
    referenceUrls           = $urls -join ", " # adding URLs
    referenceTags           = $tags -join ", " # adding Tags
})


# Display the object
$cveObject | Format-List
